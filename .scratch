#!/usr/bin/awk -f

BEGIN {
    FS = "#";  # Set field separator to '#'
    OFS = "\t"; # Set output field separator to tab
    print "Datetime", "Key", "Processed", "Pending Messages", "Total Processed";
}

{
    # Extract datetime up to the minute (remove seconds and milliseconds)
    datetime_minute = substr($1, 1, 12);
    key = $2;
    running_total = $3 + 0;  # Ensure numeric conversion
    pending_messages = $4 + 0;  # Ensure numeric conversion

    # Initialize arrays for the first occurrence of a key in a minute
    if (!(datetime_minute in initial_running_total) || !(key in initial_running_total[datetime_minute])) {
        initial_running_total[datetime_minute, key] = running_total;
        total_pending[datetime_minute, key] = 0;
        count[datetime_minute, key] = 0;
    }

    # Store the latest running total and accumulate pending messages
    final_running_total[datetime_minute, key] = running_total;
    total_pending[datetime_minute, key] += pending_messages;
    count[datetime_minute, key] += 1;
}

END {
    # Iterate through the collected data and calculate the required metrics
    for (key_minute in initial_running_total) {
        split(key_minute, keys, SUBSEP);  # Split the composite key into datetime and key
        datetime_minute = keys[1];
        key = keys[2];

        # Calculate processed value
        processed = final_running_total[datetime_minute, key] - initial_running_total[datetime_minute, key];

        # Calculate average pending messages
        avg_pending = total_pending[datetime_minute, key] / count[datetime_minute, key];

        # Print the results
        print datetime_minute, key, processed, avg_pending, processed;
    }
}
